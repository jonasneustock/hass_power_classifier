{% extends "layout.html" %}
{% block content %}
<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <h2 class="text-lg font-semibold">Live intake</h2>
      <p class="text-sm text-slate-500">Poll every {{ config.poll_interval }}s</p>
    </div>
    {% if latest_sample %}
    <div class="flex gap-6 text-sm">
      <div>
        <p class="text-slate-500">Latest wattage</p>
        <p class="text-lg font-semibold">{{ latest_sample.value }} W</p>
      </div>
      <div>
        <p class="text-slate-500">Last update</p>
        <p class="text-lg font-semibold">{{ latest_sample.ts | format_ts }}</p>
      </div>
    </div>
    {% endif %}
  </div>
  {% if not latest_sample %}
  <p class="mt-4 text-sm text-slate-500">No samples yet. Verify Home Assistant settings.</p>
  {% endif %}
</section>

{% if latest_per_sensor %}
<section class="panel">
  <div class="panel-header">
    <h2>Per-sensor latest</h2>
  </div>
  <table>
    <thead>
      <tr>
        <th>Sensor</th>
        <th>Value (W)</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody>
      {% for sensor, item in latest_per_sensor.items() %}
      <tr>
        <td>{{ sensor }}</td>
        <td>{{ item.value }}</td>
        <td>{{ item.ts | format_ts }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <div class="flex items-center justify-between">
    <h2 class="text-lg font-semibold">Overall power change</h2>
    {% if recent_samples %}
    <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">{{ recent_samples | length }} samples</span>
    {% endif %}
  </div>
  {% if recent_samples %}
  <canvas class="mt-4 w-full rounded-xl border border-slate-200" width="900" height="260" data-chart='{{ recent_samples | tojson }}' data-events='{{ detection_events | tojson }}'></canvas>
  <p class="mt-2 text-xs text-slate-500">
    Window: {{ recent_samples[0].ts | format_ts }} to {{ recent_samples[-1].ts | format_ts }}
  </p>
  {% else %}
  <p class="mt-3 text-sm text-slate-500">No samples yet.</p>
  {% endif %}
</section>

{% if recent_by_sensor %}
{% if recent_by_sensor %}
<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <div class="flex items-center justify-between">
    <h2 class="text-lg font-semibold">Per-sensor power</h2>
  </div>
  <div class="mt-4">
    <canvas class="mt-3 w-full rounded-lg border border-slate-200" width="900" height="300" data-chart-group='{{ recent_by_sensor | tojson }}' data-events='{{ detection_events | tojson }}'></canvas>
    <p class="mt-1 text-xs text-slate-500">Combined view of all sensors</p>
  </div>
</section>
{% endif %}

<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <div class="flex items-center justify-between">
    <h2 class="text-lg font-semibold">Training status</h2>
  </div>
  <div class="mt-3 grid gap-3 text-sm">
    {% if training %}
    <div class="grid grid-cols-2 gap-4">
      <div class="rounded-xl bg-slate-50 p-4">
        <p class="text-slate-500">Samples</p>
        <p class="text-lg font-semibold">{{ training.samples }}</p>
      </div>
      <div class="rounded-xl bg-slate-50 p-4">
        <p class="text-slate-500">Classes</p>
        <p class="text-lg font-semibold">{{ training.classes }}</p>
      </div>
    </div>
    {% else %}
    <p class="text-sm text-slate-500">Not trained yet. Label more segments.</p>
    {% endif %}
    <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
      <p class="text-slate-500">
        Status:
        {% if training_state.running %}
          <span class="font-semibold text-amber-700">Trainingâ€¦</span>
        {% elif training_state.error %}
          <span class="font-semibold text-red-700">Failed</span>
        {% else %}
          <span class="font-semibold text-emerald-700">Idle</span>
        {% endif %}
      </p>
      {% if training_state.error %}
      <p class="mt-1 text-sm text-red-700">Last error: {{ training_state.error }}</p>
      {% endif %}
      <p class="mt-1 text-xs text-slate-500">
        Last started: {{ training_state.last_started | default('n/a') | format_ts }} |
        Last finished: {{ training_state.last_finished | default('n/a') | format_ts }}
      </p>
    </div>
  </div>
</section>

<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <div class="flex items-center justify-between">
    <h2 class="text-lg font-semibold">Appliances</h2>
  </div>
  {% if appliances %}
  <div class="mt-4 grid gap-4 md:grid-cols-2">
    {% for appliance in appliances %}
    <div class="rounded-xl border border-slate-200 p-4">
      <h3 class="text-base font-semibold">{{ appliance.name }}</h3>
      <p class="text-sm text-slate-600">Status entity: {{ appliance.status_entity_id }}</p>
      <p class="text-sm text-slate-600">Power entity: {{ appliance.power_entity_id }}</p>
      <p class="text-sm text-slate-600">Learned power (min/mean/max): {{ appliance.min_power or 0 }} / {{ appliance.mean_power or appliance.running_watts or 0 }} / {{ appliance.max_power or 0 }} W</p>
      <p class="text-sm text-slate-600">Last status: {{ appliance.last_status or 'unknown' }}</p>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="mt-2 text-sm text-slate-500">No appliances configured yet.</p>
  {% endif %}
</section>

<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <div class="flex items-center justify-between">
    <h2 class="text-lg font-semibold">Unlabeled segments</h2>
    <a class="text-sm font-semibold text-blue-600 hover:text-blue-700" href="/segments">Review all</a>
  </div>
  {% if segments %}
  <div class="mt-4 overflow-x-auto rounded-xl border border-slate-200">
    <table class="min-w-full divide-y divide-slate-200 text-sm">
      <thead class="bg-slate-50">
        <tr>
          <th class="px-4 py-2 text-left font-semibold text-slate-600">ID</th>
          <th class="px-4 py-2 text-left font-semibold text-slate-600">Window</th>
          <th class="px-4 py-2 text-left font-semibold text-slate-600">Change</th>
          <th class="px-4 py-2 text-left font-semibold text-slate-600">Candidate</th>
          <th class="px-4 py-2"></th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200">
        {% for segment in segments %}
        <tr>
          <td class="px-4 py-2 font-medium text-slate-800">#{{ segment.id }}</td>
          <td class="px-4 py-2 text-slate-700">{{ segment.start_ts | format_ts }} - {{ segment.end_ts | format_ts }}</td>
          <td class="px-4 py-2 text-slate-700">{{ (segment.change_score * 100) | round(1) }}%</td>
          <td class="px-4 py-2 text-slate-700">{{ 'yes' if segment.candidate else 'no' }}</td>
          <td class="px-4 py-2 text-right"><a class="text-blue-600 hover:text-blue-700" href="/segments/{{ segment.id }}">Label</a></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="mt-3 text-sm text-slate-500">No new segments to label.</p>
  {% endif %}
</section>
{% endblock %}
