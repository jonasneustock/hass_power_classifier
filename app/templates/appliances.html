{% extends "layout.html" %}
{% block content %}
<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <div class="flex items-center justify-between">
    <h2 class="text-lg font-semibold">Register appliance</h2>
  </div>
  {% if error %}
  <div class="mt-3 rounded-lg border border-amber-300 bg-amber-50 px-4 py-3 text-sm text-amber-800">{{ error }}</div>
  {% endif %}
  <form class="mt-4 grid gap-4" method="post" action="/appliances">
    <label class="text-sm font-medium text-slate-700">
      Appliance name
      <input class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" type="text" name="name" value="{{ form.name if form else '' }}" required />
    </label>
    <label class="text-sm font-medium text-slate-700">
      Power entity id
      <input class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" type="text" name="power_entity_id" placeholder="sensor.toaster_power" value="{{ form.power_entity_id if form else '' }}" required />
    </label>
    <label class="text-sm font-medium text-slate-700">
      Activity sensors (comma-separated)
      <input class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" type="text" name="activity_sensors" placeholder="binary_sensor.toaster_activity" value="{{ form.activity_sensors if form else '' }}" />
      <span class="mt-1 block text-xs text-slate-500">Reads Home Assistant binary sensors with states "on"/"off" to hint start/stop labels.</span>
    </label>
    <label class="flex items-center gap-2 text-sm font-medium text-slate-700">
      <input type="checkbox" name="learning_appliance" value="1" {% if form and form.learning_appliance %}checked{% endif %} />
      Learning appliance (auto-label from its own power sensor)
    </label>
    <label class="text-sm font-medium text-slate-700">
      Learning sensor entity id
      <input class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" type="text" name="learning_sensor_id" placeholder="sensor.toaster_power_input" value="{{ form.learning_sensor_id if form else '' }}" />
      <span class="mt-1 block text-xs text-slate-500">Used to auto-detect start/stop and auto-label segments.</span>
    </label>
    <div class="grid gap-4 md:grid-cols-2">
      <label class="text-sm font-medium text-slate-700">
        User min power (W)
        <input class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" type="number" step="0.01" name="user_min_power" value="{{ form.user_min_power if form else '' }}" />
      </label>
      <label class="text-sm font-medium text-slate-700">
        User max power (W)
        <input class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" type="number" step="0.01" name="user_max_power" value="{{ form.user_max_power if form else '' }}" />
      </label>
    </div>
    {% if config.mqtt_enabled %}
    <p class="text-sm text-slate-500">When MQTT is enabled, the entity IDs are used as discovery object IDs.</p>
    {% endif %}
    <button class="inline-flex w-fit items-center rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800" type="submit">Create appliance</button>
  </form>
</section>

<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <div class="flex items-center justify-between">
    <h2 class="text-lg font-semibold">Configured appliances</h2>
  </div>
  {% if appliances %}
  <div class="mt-4 grid gap-4 md:grid-cols-2">
    {% for appliance in appliances %}
    <div class="rounded-xl border border-slate-200 p-4 overflow-hidden">
      <div class="flex items-start justify-between gap-4">
        <div class="min-w-0">
          <h3 class="truncate text-base font-semibold">{{ appliance.name }}</h3>
          <p class="truncate text-sm text-slate-600">Power entity: {{ appliance.power_entity_id }}</p>
          {% if appliance.activity_sensors %}
          <p class="truncate text-sm text-slate-600">Activity sensors: {{ appliance.activity_sensors }}</p>
          {% endif %}
          {% if appliance.learning_appliance %}
          <p class="truncate text-xs font-semibold text-amber-700">Learning appliance ({{ appliance.learning_sensor_id }})</p>
          {% endif %}
      {% if config.mqtt_enabled %}
      <p class="truncate text-sm text-slate-600">MQTT power topic: <code class="rounded bg-slate-100 px-2 py-1 text-xs text-slate-700">{{ appliance.power_state_topic }}</code></p>
      <p class="truncate text-xs text-slate-500">
        Discovery: <code class="rounded bg-slate-100 px-2 py-1 text-xs text-slate-700">{{ appliance.power_config_topic }}</code>
      </p>
      {% endif %}
      <p class="truncate text-sm text-slate-600">Regression min/mean/max (W): {{ appliance.min_power or 0 }} / {{ appliance.mean_power or appliance.running_watts or 0 }} / {{ appliance.max_power or 0 }}</p>
      {% if appliance.user_min_power or appliance.user_max_power %}
      <p class="truncate text-xs text-slate-500">User min/max override (W): {{ appliance.user_min_power or '—' }} / {{ appliance.user_max_power or '—' }}</p>
      {% endif %}
      <p class="truncate text-sm text-slate-600">Current published power: {{ appliance.current_power or 0 }} W</p>
        </div>
        <details class="w-48 rounded-lg border border-slate-200 bg-slate-50 p-3 text-sm text-slate-700">
          <summary class="cursor-pointer text-xs font-semibold text-slate-600">Edit</summary>
          <form class="mt-2 space-y-2" method="post" action="/appliances/{{ appliance.name }}/update">
            <label class="block text-xs">
              Power entity
              <input class="mt-1 w-full rounded border-slate-300 text-sm focus:border-blue-500 focus:ring-blue-500" type="text" name="power_entity_id" value="{{ appliance.power_entity_id }}" />
            </label>
            <label class="block text-xs">
              Activity sensors
              <input class="mt-1 w-full rounded border-slate-300 text-sm focus:border-blue-500 focus:ring-blue-500" type="text" name="activity_sensors" value="{{ appliance.activity_sensors }}" />
            </label>
            <label class="block text-xs">
              Learning sensor
              <input class="mt-1 w-full rounded border-slate-300 text-sm focus:border-blue-500 focus:ring-blue-500" type="text" name="learning_sensor_id" value="{{ appliance.learning_sensor_id }}" />
              <input type="hidden" name="learning_appliance" value="{{ appliance.learning_appliance }}" />
            </label>
            <label class="block text-xs">
              User min power (W)
              <input class="mt-1 w-full rounded border-slate-300 text-sm focus:border-blue-500 focus:ring-blue-500" type="number" step="0.01" name="user_min_power" value="{{ appliance.user_min_power }}" />
            </label>
            <label class="block text-xs">
              User max power (W)
              <input class="mt-1 w-full rounded border-slate-300 text-sm focus:border-blue-500 focus:ring-blue-500" type="number" step="0.01" name="user_max_power" value="{{ appliance.user_max_power }}" />
            </label>
            <button class="w-full rounded bg-slate-900 px-3 py-1 text-xs font-semibold text-white hover:bg-slate-800" type="submit">Save</button>
          </form>
          <form class="mt-2 space-y-2" method="post" action="/appliances/{{ appliance.name }}/rename">
            <label class="block text-xs">
              Rename
              <input class="mt-1 w-full rounded border-slate-300 text-sm focus:border-blue-500 focus:ring-blue-500" type="text" name="new_name" value="{{ appliance.name }}" required />
            </label>
            <button class="w-full rounded bg-amber-600 px-3 py-1 text-xs font-semibold text-white hover:bg-amber-500" type="submit">Rename</button>
          </form>
          <form class="mt-2" method="post" action="/appliances/{{ appliance.name }}/delete" onsubmit="return confirm('Delete appliance {{ appliance.name }}?');">
            <button class="w-full rounded border border-red-300 px-3 py-1 text-xs font-semibold text-red-700 hover:bg-red-50" type="submit">Delete</button>
          </form>
        </details>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="mt-2 text-sm text-slate-500">No appliances configured yet.</p>
  {% endif %}
</section>
{% endblock %}
